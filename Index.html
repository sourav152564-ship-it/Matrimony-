<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <title>Matrimonial Demo</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js?59"></script>
  <!-- CryptoJS for password hashing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Firebase (optional, for image storage) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage.js"></script>
  <style>
    :root { --primary: #ff4d6d; --muted: #777; }
    body { font-family: Arial, sans-serif; margin: 0; background: #f4f6f8; color: #222; }
    header { background: var(--primary); color: #fff; padding: 10px; display: flex; align-items: center; justify-content: space-between; }
    header h1 { margin: 0; font-size: 18px; }
    nav { background: #fff; padding: 6px; display: flex; gap: 6px; justify-content: center; box-shadow: 0 1px 4px rgba(0,0,0,.06); display: none; }
    nav button { background: var(--primary); color: #fff; border: 0; padding: 6px; border-radius: 50%; font-size: 13px; cursor: pointer; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; }
    nav button i { font-size: 16px; }
    .container { padding: 12px; max-width: 980px; margin: 14px auto; }
    section { display: none; }
    .card { background: #fff; padding: 12px; border-radius: 10px; box-shadow: 0 1px 6px rgba(0,0,0,.04); margin-bottom: 12px; }
    input, textarea { width: 100%; padding: 8px; margin: 6px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
    .row { display: flex; gap: 10px; }
    .col { flex: 1; }
    img.profile-thumb { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; }
    .small { font-size: 13px; color: var(--muted); }
    .error-message { color: #d32f2f; font-size: 13px; margin: 4px 0; padding: 6px; border-radius: 4px; background: #ffebee; display: none; }
    .success-message { color: #2e7d32; font-size: 13px; margin: 4px 0; padding: 6px; border-radius: 4px; background: #e8f5e9; display: none; }
    .password-toggle { cursor: pointer; color: var(--primary); font-size: 12px; margin-top: 2px; }
    #loading { background: #fff; padding: 10px; border-radius: 8px; box-shadow: 0 1px 6px rgba(0,0,0,.04); text-align: center; display: none; }
    footer { padding: 12px; text-align: center; color: var(--muted); font-size: 13px; }
    @media(max-width:600px) {
      header h1 { font-size: 16px; }
      .row { flex-direction: column; }
      .card { padding: 10px; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Matrimonial Demo</h1>
    <div class="right">
      <select id="languageSelector" onchange="setLanguage(this.value)" aria-label="Select Language">
        <option value="bn">বাংলা</option>
        <option value="en">English</option>
      </select>
    </div>
  </header>

  <nav id="mainNav">
    <button id="navProfile" onclick="showSection('profilePanel')" title="প্রোফাইল"><i class="fas fa-user"></i></button>
    <button id="navFeed" onclick="showSection('feedPanel')" title="নিউজফিড"><i class="fas fa-newspaper"></i></button>
    <button id="navLogout" onclick="logout()" title="লগআউট"><i class="fas fa-sign-out-alt"></i></button>
  </nav>

  <div class="container">
    <div id="loading">Loading...</div>

    <!-- LOGIN -->
    <section id="loginPanel" class="card" style="display:block">
      <h2 id="loginTitle">লগইন করুন</h2>
      <div id="loginMessage" class="success-message"></div>
      <div id="loginError" class="error-message"></div>
      <input id="loginEmail" type="email" placeholder="ইমেইল" required aria-label="Email">
      <div style="position:relative">
        <input id="loginPass" type="password" placeholder="পাসওয়ার্ড" required aria-label="Password">
        <span class="password-toggle" onclick="togglePassword('loginPass', this)">দেখান</span>
      </div>
      <div class="row">
        <button onclick="doLogin()" style="flex:1" aria-label="Login">লগইন</button>
        <button onclick="showSection('signupPanel')" class="btn-outline" style="flex:1" aria-label="Signup">সাইনআপ</button>
      </div>
    </section>

    <!-- SIGNUP -->
    <section id="signupPanel" class="card">
      <h2 id="signupTitle">সাইনআপ</h2>
      <div id="signupError" class="error-message"></div>
      <input id="regName" placeholder="নাম" required aria-label="Name">
      <input id="regEmail" type="email" placeholder="ইমেইল" required aria-label="Email">
      <div style="position:relative">
        <input id="regPass" type="password" placeholder="পাসওয়ার্ড" required aria-label="Password">
        <span class="password-toggle" onclick="togglePassword('regPass', this)">দেখান</span>
      </div>
      <div class="row">
        <button onclick="doSignup()" style="flex:1" aria-label="Register">নিবন্ধন</button>
        <button onclick="showSection('loginPanel')" class="btn-outline" style="flex:1" aria-label="Back">ফিরে যান</button>
      </div>
    </section>

    <!-- PROFILE -->
    <section id="profilePanel" class="card">
      <div style="display:flex;gap:12px;align-items:center">
        <img id="mePic" class="profile-thumb" src="" alt="Profile picture">
        <div>
          <h3 id="meName"></h3>
          <div class="small" id="meEmail"></div>
        </div>
        <button onclick="toggleEditMe()" class="btn-outline" aria-label="Edit profile">Edit</button>
      </div>
      <div id="meEdit" class="hidden" style="margin-top:10px">
        <input id="meNameInput" placeholder="নাম" aria-label="Name">
        <input id="mePicInput" type="file" accept="image/*" onchange="updateMyPic(this)" aria-label="Profile picture">
        <div class="row">
          <button onclick="saveMe()" aria-label="Save">Save</button>
          <button onclick="toggleEditMe()" class="btn-outline" aria-label="Cancel">Cancel</button>
        </div>
      </div>
    </section>

    <!-- FEED -->
    <section id="feedPanel" class="card">
      <h3>নিউজফিড</h3>
      <div class="card">
        <textarea id="newPostText" placeholder="কী ভাবছেন?" aria-label="Write a post"></textarea>
        <input id="newPostImages" type="file" accept="image/*" multiple onchange="previewPostImages(this)" aria-label="Add images">
        <div id="postPreview" class="gallery"></div>
        <div class="row">
          <button onclick="createPost()" aria-label="Post">পোস্ট</button>
          <button onclick="clearPost()" class="btn-outline" aria-label="Clear">ক্লিয়ার</button>
        </div>
      </div>
      <div id="feedArea"></div>
    </section>
  </div>

  <footer>Demo — data stored in Telegram Cloud</footer>

<script>
const tg = window.Telegram.WebApp;
tg.ready();
tg.expand();

const localStorage = tg.DeviceStorage;
const secureStorage = tg.SecureStorage;

// Initialize Firebase (replace with your config)
const firebaseConfig = {
  // Add your Firebase config here (apiKey, authDomain, projectId, etc.)
  // Example: apiKey: "your-api-key", authDomain: "your-project.firebaseapp.com", ...
};
firebase.initializeApp(firebaseConfig);
const storage = firebase.storage();

function uid(prefix = 'id') { return prefix + Math.random().toString(36).slice(2, 9); }

let store = {
  users: null,
  posts: []
};

function loadStore(callback) {
  showLoading();
  const keys = ['mm_users', 'mm_posts'];
  const results = {};
  let completed = 0;

  keys.forEach(key => {
    if (key === 'mm_users') {
      secureStorage.getItem(key, (error, value, isRestored) => {
        if (error) {
          console.error('Error loading users:', error);
          results[key] = null;
        } else if (!isRestored) {
          secureStorage.restoreItem(key, (restoreError) => {
            if (restoreError) {
              console.error('Restore failed for users:', restoreError);
              results[key] = null;
            } else {
              secureStorage.getItem(key, (err, val) => {
                results[key] = val ? JSON.parse(val) : null;
                completed++;
                if (completed === keys.length) {
                  store = {
                    users: results.mm_users || store.users,
                    posts: results.mm_posts || []
                  };
                  callback();
                  hideLoading();
                }
              });
            }
          });
        } else {
          results[key] = value ? JSON.parse(value) : null;
          completed++;
          if (completed === keys.length) {
            store = {
              users: results.mm_users || store.users,
              posts: results.mm_posts || []
            };
            callback();
            hideLoading();
          }
        }
      });
    } else {
      localStorage.getItem(key, (error, value) => {
        if (error) {
          console.error(`Error loading ${key}:`, error);
          results[key] = null;
        } else {
          results[key] = value ? JSON.parse(value) : null;
        }
        completed++;
        if (completed === keys.length) {
          store = {
            users: results.mm_users || store.users,
            posts: results.mm_posts || []
          };
          callback();
          hideLoading();
        }
      });
    }
  });
}

function persist() {
  showLoading();
  secureStorage.setItem('mm_users', JSON.stringify(store.users), (error) => {
    if (error) console.error('Error saving users:', error);
  });
  localStorage.setItem('mm_posts', JSON.stringify(store.posts), (error) => {
    if (error) console.error('Error saving posts:', error);
  });
  hideLoading();
}

function initializeDefaultData() {
  if (!store.users) {
    store.users = [
      {
        id: 'u1',
        telegramId: null,
        name: 'Sourav Dey',
        email: 'sourav@example.com',
        pass: CryptoJS.SHA256('1234').toString(),
        pic: ''
      }
    ];
    store.posts = [
      { id: 'p1', userId: 'u1', text: 'Welcome to the demo!', images: [], time: Date.now() }
    ];
    persist();
  }
}

function showLoading() { document.getElementById('loading').style.display = 'block'; }
function hideLoading() { document.getElementById('loading').style.display = 'none'; }
function sanitizeInput(str) { return String(str).replace(/[<>]/g, ''); }
function hashPassword(password) { return CryptoJS.SHA256(password).toString(); }

function compressImage(file, callback, maxDim = 200) {
  const reader = new FileReader();
  reader.onload = (e) => {
    const img = new Image();
    img.onload = () => {
      const canvas = document.createElement('canvas');
      let { width, height } = img;
      if (width > height) {
        if (width > maxDim) {
          height *= maxDim / width;
          width = maxDim;
        }
      } else {
        if (height > maxDim) {
          width *= maxDim / height;
          height = maxDim;
        }
      }
      canvas.width = width;
      canvas.height = height;
      canvas.getContext('2d').drawImage(img, 0, 0, width, height);
      canvas.toBlob(callback, 'image/jpeg', 0.7);
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

let currentUser = null;

function showSection(id) {
  ['loginPanel', 'signupPanel', 'profilePanel', 'feedPanel'].forEach(s => {
    document.getElementById(s).style.display = 'none';
  });
  ['loginError', 'signupError', 'loginMessage'].forEach(e => {
    document.getElementById(e).style.display = 'none';
    document.getElementById(e).textContent = '';
  });
  document.getElementById(id).style.display = 'block';
}

function showError(elementId, message) {
  const errorEl = document.getElementById(elementId);
  errorEl.textContent = message;
  errorEl.style.display = 'block';
}

function showSuccess(elementId, message) {
  const successEl = document.getElementById(elementId);
  successEl.textContent = message;
  successEl.style.display = 'block';
}

function validateEmail(email) {
  const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return re.test(email);
}

function togglePassword(inputId, toggleEl) {
  const input = document.getElementById(inputId);
  if (input.type === 'password') {
    input.type = 'text';
    toggleEl.textContent = translations[currentLang].hide;
  } else {
    input.type = 'password';
    toggleEl.textContent = translations[currentLang].show;
  }
}

function doSignup() {
  showLoading();
  setTimeout(() => {
    const name = sanitizeInput(document.getElementById('regName').value.trim());
    const email = document.getElementById('regEmail').value.trim();
    const pass = document.getElementById('regPass').value;
    const telegramUser = tg.initDataUnsafe.user;

    if (!name || !email || !pass || !telegramUser) {
      showError('signupError', translations[currentLang].fillAllFields);
      hideLoading();
      return;
    }
    if (!validateEmail(email)) {
      showError('signupError', translations[currentLang].invalidEmail);
      hideLoading();
      return;
    }
    if (pass.length < 6) {
      showError('signupError', translations[currentLang].passwordTooShort);
      hideLoading();
      return;
    }
    if (store.users.some(u => u.email === email)) {
      showError('signupError', translations[currentLang].emailExists);
      hideLoading();
      return;
    }

    const newU = {
      id: uid('u'),
      telegramId: telegramUser.id,
      name,
      email,
      pass: hashPassword(pass),
      pic: ''
    };
    store.users.push(newU);
    persist();

    document.getElementById('regName').value = '';
    document.getElementById('regEmail').value = '';
    document.getElementById('regPass').value = '';
    document.querySelector('#regPass + .password-toggle').textContent = translations[currentLang].show;

    showSection('loginPanel');
    showSuccess('loginMessage', translations[currentLang].signupSuccess);
    document.getElementById('loginEmail').focus();
    hideLoading();
  }, 500);
}

function doLogin() {
  showLoading();
  setTimeout(() => {
    const telegramUser = tg.initDataUnsafe.user;
    if (!telegramUser) {
      showError('loginError', translations[currentLang].invalidCredentials);
      hideLoading();
      return;
    }
    const user = store.users.find(u => u.telegramId === telegramUser.id);
    if (!user) {
      showError('loginError', translations[currentLang].emailNotFound);
      hideLoading();
      return;
    }
    currentUser = user;
    document.getElementById('loginEmail').value = '';
    document.getElementById('loginPass').value = '';
    document.querySelector('#loginPass + .password-toggle').textContent = translations[currentLang].show;
    onLogin();
    hideLoading();
  }, 500);
}

function onLogin() {
  document.getElementById('mainNav').style.display = 'flex';
  renderMyProfile();
  renderFeed();
  showSection('profilePanel');
}

function renderMyProfile() {
  if (!currentUser) return;
  document.getElementById('meName').textContent = currentUser.name;
  document.getElementById('meEmail').textContent = currentUser.email;
  document.getElementById('mePic').src = currentUser.pic || DEFAULT_IMAGE;
}

function toggleEditMe() {
  document.getElementById('meEdit').classList.toggle('hidden');
  if (!document.getElementById('meEdit').classList.contains('hidden')) {
    document.getElementById('meNameInput').value = currentUser.name;
  }
}

function saveMe() {
  showLoading();
  setTimeout(() => {
    currentUser.name = sanitizeInput(document.getElementById('meNameInput').value || currentUser.name);
    persist();
    renderMyProfile();
    toggleEditMe();
    alert(translations[currentLang].saved);
    hideLoading();
  }, 500);
}

function updateMyPic(inp) {
  const file = inp.files[0];
  if (!file) return;
  compressImage(file, (blob) => {
    const storageRef = storage.ref(`profile_pics/${currentUser.id}/${file.name}`);
    storageRef.put(blob).then(() => {
      storageRef.getDownloadURL().then((url) => {
        currentUser.pic = url;
        const post = {
          id: uid('p'),
          userId: currentUser.id,
          text: `${currentUser.name} ${translations[currentLang].updatedProfilePic}`,
          images: [currentUser.pic],
          time: Date.now()
        };
        store.posts.unshift(post);
        persist();
        renderMyProfile();
        renderFeed();
      }).catch(error => console.error('Image upload failed:', error));
    });
  });
}

function previewPostImages(inp) {
  const files = Array.from(inp.files || []);
  const preview = document.getElementById('postPreview');
  preview.innerHTML = '';
  files.forEach(f => compressImage(f, (blob) => {
    const img = document.createElement('img');
    img.src = URL.createObjectURL(blob);
    preview.appendChild(img);
  }));
}

function createPost() {
  if (!currentUser) return alert(translations[currentLang].loginFirst);
  const text = sanitizeInput(document.getElementById('newPostText').value.trim());
  const files = document.getElementById('newPostImages').files;
  const images = [];
  const done = () => {
    const post = { id: uid('p'), userId: currentUser.id, text, images, time: Date.now() };
    store.posts.unshift(post);
    persist();
    renderFeed();
    clearPost();
  };
  if (files.length === 0) return done();
  let uploaded = 0;
  Array.from(files).forEach(f => compressImage(f, (blob) => {
    const storageRef = storage.ref(`posts/${currentUser.id}/${f.name}`);
    storageRef.put(blob).then(() => {
      storageRef.getDownloadURL().then((url) => {
        images.push(url);
        uploaded++;
        if (uploaded === files.length) done();
      });
    });
  }));
}

function clearPost() {
  document.getElementById('newPostText').value = '';
  document.getElementById('newPostImages').value = '';
  document.getElementById('postPreview').innerHTML = '';
}

function renderFeed() {
  const area = document.getElementById('feedArea');
  area.innerHTML = '';
  store.posts.forEach(p => {
    const user = store.users.find(u => u.id === p.userId) || {};
    const card = document.createElement('div');
    card.className = 'card';
    let html = `<div style="display:flex;gap:8px;align-items:center"><img src="${user.pic || DEFAULT_IMAGE}" class="profile-thumb" alt="${user.name}'s picture"/><div><strong>${user.name || 'Unknown'}</strong><div class="small">${new Date(p.time).toLocaleString()}</div></div></div>`;
    html += `<p style="margin-top:8px">${escapeHtml(p.text || '')}</p>`;
    if (p.images && p.images.length) {
      html += `<div class="gallery">${p.images.map(i => `<img src="${i}" alt="Post image">`).join('')}</div>`;
    }
    card.innerHTML = html;
    area.appendChild(card);
  });
}

function logout() {
  currentUser = null;
  document.getElementById('mainNav').style.display = 'none';
  showSection('loginPanel');
}

function escapeHtml(str = '') { return String(str).replace(/[&<>"']/g, s => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' })[s]); }

const DEFAULT_IMAGE = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(
  `<svg xmlns="http://www.w3.org/2000/svg" width="120" height="120"><rect width="100%" height="100%" fill="#eee"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#bbb" font-size="14">No Image</text></svg>`
);

let currentLang = 'bn';
const translations = {
  bn: {
    login: 'লগইন',
    signup: 'সাইনআপ',
    profile: 'প্রোফাইল',
    feed: 'নিউজফিড',
    logout: 'লগআউট',
    fillAllFields: 'সমস্ত ক্ষেত্র পূরণ করুন',
    invalidEmail: 'বৈধ ইমেইল প্রবেশ করান',
    passwordTooShort: 'পাসওয়ার্ড কমপক্ষে ৬ অক্ষরের হতে হবে',
    emailExists: 'ইমেইল ইতিমধ্যে নিবন্ধিত',
    signupSuccess: 'নিবন্ধন সফল! এখন লগইন করুন।',
    invalidCredentials: 'ভুল ইমেইল বা পাসওয়ার্ড',
    emailNotFound: 'ইমেইলটি নিবন্ধিত নয়',
    show: 'দেখান',
    hide: 'লুকান',
    loginFirst: 'প্রথমে লগইন করুন',
    saved: 'সংরক্ষিত',
    updatedProfilePic: 'নতুন প্রোফাইল ছবি আপডেট করেছেন'
  },
  en: {
    login: 'Login',
    signup: 'Signup',
    profile: 'Profile',
    feed: 'Feed',
    logout: 'Logout',
    fillAllFields: 'Please fill all fields',
    invalidEmail: 'Enter a valid email',
    passwordTooShort: 'Password must be at least 6 characters',
    emailExists: 'Email already registered',
    signupSuccess: 'Registration successful! Please login.',
    invalidCredentials: 'Invalid email or password',
    emailNotFound: 'Email not registered',
    show: 'Show',
    hide: 'Hide',
    loginFirst: 'Please login first',
    saved: 'Saved',
    updatedProfilePic: 'updated their profile picture'
  }
};

function setLanguage(lang) {
  if (!translations[lang]) lang = 'bn';
  currentLang = lang;
  const t = translations[lang];
  document.getElementById('loginTitle').textContent = t.login;
  document.getElementById('signupTitle').textContent = t.signup;
  document.getElementById('navProfile').title = t.profile;
  document.getElementById('navFeed').title = t.feed;
  document.getElementById('navLogout').title = t.logout;
  document.getElementById('newPostText').placeholder = t.writeComment;
  renderMyProfile();
  renderFeed();
}

(function init() {
  ['signupPanel', 'profilePanel', 'feedPanel'].forEach(s => document.getElementById(s).style.display = 'none');
  setLanguage('bn');
  document.getElementById('loginEmail').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') doLogin();
  });
  document.getElementById('regEmail').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') doSignup();
  });
  loadStore(() => {
    initializeDefaultData();
    if (currentUser) onLogin();
  });
})();
</script>
</body>
</html>
